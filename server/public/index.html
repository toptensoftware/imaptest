<html>
<head>

    <style>
        html
        {
            font-family: Lato, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
    </style>

    <script>

        function setCsrfToken(token)
        {
            if (token == null)
                localStorage.removeItem("x-csrf-token");
            else
                localStorage.setItem("x-csrf-token", token);
        }

        function getCsrfToken()
        {
            return localStorage.getItem("x-csrf-token")
        }

        /*
        function cookies()
        {
            return document.cookie.split(';').reduce((cookies, cookie) => {
                const [ name, value ] = cookie.split('=').map(c => c.trim());
                cookies[name] = value;
                return cookies;
            }, {});            
        }
        */

        async function fetchJson(method, endPoint, data)
        {            
            let options = {
                method: method,
                credentials: "same-origin",
                cache: "no-cache",
                body: JSON.stringify(data),
                headers: {}
            }
            if (method == 'POST')
                options.headers['Content-Type'] = 'application/json';

            let csrf_token = getCsrfToken();
            if (csrf_token)
                options.headers['x-csrf-token'] = csrf_token;

            let response = await fetch(endPoint, options);
            if (response.status < 200 || response.status > 299)
                throw new Error("Server error:" + response.status);
                
            let rdata = await response.json();

            for (let [k,v] of response.headers)
            {
                if (k == "x-csrf-token")
                    setCsrfToken(v);
            }

            return rdata;
        }

        async function post(endPoint, data)
        {
            return fetchJson("POST", endPoint, data);
        }

        async function get(endPoint)
        {
            return fetchJson("GET", endPoint);
        }

        function showToken()
        {
            alert(`csrf_token: ${getCsrfToken()}`);
        }

        async function login()
        {
            try
            {
                let r = await post("/api/login", { 
                    user: "brad@rocketskeleton.com", 
                    pass:"rafiki23",
                    /*
                    "u
                    ser": "brad@toptensoftware.com",
                    "pass": "ormapkrcwiipjwik-1U",
                    */
                    persistent: true,
                });

                alert("Logged in");
            }
            catch (err)
            {
                alert(err.message);
            }
        }

        async function logout()
        {
            try
            {
                let r = await post("/api/logout", { });
                setCsrfToken(null);
                alert("Logged out");

            }
            catch (err)
            {
                alert(err.message);
            }
        }

        async function refresh()
        {
            try
            {
                let r = await post("/api/sync", { });
                openhash();
            }
            catch (err)
            {
                alert(err.message);
            }
            
        }

        function e(str)
        {
            if (!str)
                return "";
            return str.replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#39;");        
        }

        async function showFolders()
        {
            try
            {
                let start = Date.now();
                let r = await get("/api/folders");
                let elapsed = Date.now() - start;

                document.getElementById("status").innerText = 
                    `revision: ${r.revision} length: ${JSON.stringify(r).length} elapsed: ${elapsed} ms`;

                let html = "";
                html += `<h2><a href="#?folder=">All Conversations</a></h2>`;

                for (let f of r.mailboxes)
                {
                    html += `<h2><a href="#?folder=${f.name}">${e(f.name)}</a></h2>`;
                    html += `<pre>${e(JSON.stringify(f, null, 4))}</pre>`;
                }

                document.getElementById("data").innerHTML = html;
            }
            catch (err)
            {
                alert(err.message);
            }
        }

        async function showConversations(mailbox)
        {
            try
            {
                let url = "/api/conversations";
                if (mailbox)
                    url += "?mailbox=" + mailbox;

                let start = Date.now();
                let r = await get(url);
                let elapsed = Date.now() - start;
                document.getElementById("status").innerText = `length: ${JSON.stringify(r).length} elapsed: ${elapsed} ms`;

                let html = "";
                for (let c of r.conversations)
                {
                    html += `<h2><a href="#?conv=${c.conversation_id}">${e(c.subject ?? "<no subject>")}</a></h2>`;
                    html += `<pre>${e(JSON.stringify(c, null, 4))}</pre>`;
                }

                delete r.conversations;
                html += "<h2>Summary</h2>"
                html += `<pre>${JSON.stringify(r, null, 4)}</pre>`;


                document.getElementById("data").innerHTML = html;
            }
            catch (err)
            {
                alert(err.message);
            }
        }

        async function showConversation(conversation_id)
        {
            try
            {
                let url = "/api/conversation?conversation_id=" + conversation_id;

                let start = Date.now();
                let r = await get(url);
                let elapsed = Date.now() - start;
                document.getElementById("status").innerText = `length: ${JSON.stringify(r).length} elapsed: ${elapsed} ms`;

                let html ="";
                html += `<pre>${JSON.stringify(r, null, 4)}</pre>`;


                document.getElementById("data").innerHTML = html;
            }
            catch (err)
            {
                alert(err.message);
            }
        }

        function openhash()
        {
            if (location.hash.startsWith("#?folder="))
            {
                showConversations(location.hash.substring(9));
            }
            else if (location.hash.startsWith("#?conv="))
            {
                showConversation(location.hash.substring(7));
            }
            else
            {
                showFolders();
            }
            window.scrollTo(0, 0);
        }
        openhash();

        window.addEventListener('hashchange', openhash, false);

    </script>
</head>
<body>
    
    <p>
        <button onclick="login()">Login</button>
        <button onclick="logout()">Logout</button>
        <button onclick="refresh()">Refresh</button>
        <button onclick="showToken()">Show Token</button>
    </p>
    <a href="#">Folders</a>
    <pre id="status" style="width:100%"></pre>
    <div id="data" style="width:100%"></div>
</body>
</html>