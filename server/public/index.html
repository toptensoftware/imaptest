<html>
<head>

    <script>

        let session_id = null;

        function setCsrfToken(token)
        {
            if (token == null)
                localStorage.removeItem("x-csrf-token");
            else
                localStorage.setItem("x-csrf-token", token);
        }

        function getCsrfToken()
        {
            return localStorage.getItem("x-csrf-token")
        }

        /*
        function cookies()
        {
            return document.cookie.split(';').reduce((cookies, cookie) => {
                const [ name, value ] = cookie.split('=').map(c => c.trim());
                cookies[name] = value;
                return cookies;
            }, {});            
        }
        */

        async function fetchJson(method, endPoint, data)
        {            
            let options = {
                method: method,
                credentials: "same-origin",
                cache: "no-cache",
                body: JSON.stringify(data),
                headers: {}
            }
            if (method == 'POST')
                options.headers['Content-Type'] = 'application/json';

            let csrf_token = getCsrfToken();
            if (csrf_token)
                options.headers['x-csrf-token'] = csrf_token;
            if (session_id)
                options.headers['x-session-id'] = session_id;

            let response = await fetch(endPoint, options);
            if (response.status < 200 || response.status > 299)
                throw new Error("Server error:" + response.status);
                
            let rdata = await response.json();

            for (let [k,v] of response.headers)
            {
                if (k == "x-csrf-token")
                    setCsrfToken(v);
            }

            return rdata;
        }

        async function post(endPoint, data)
        {
            return fetchJson("POST", endPoint, data);
        }

        async function get(endPoint)
        {
            return fetchJson("GET", endPoint);
        }

        function showToken()
        {
            alert(`csrf_token: ${getCsrfToken()} session_id: ${session_id}`);
        }

        async function login()
        {
            try
            {
                let r = await post("/api/login", { 
                    user: "brad@rocketskeleton.com", 
                    pass:"rafiki23",
                    persistent: true,
                });

                alert("Logged in");
            }
            catch (err)
            {
                alert(err.message);
            }
        }

        async function logout()
        {
            try
            {
                let r = await post("/api/logout", { });
                setCsrfToken(null);
                session_id = null;
                alert("Logged out");

            }
            catch (err)
            {
                alert(err.message);
            }
        }

        async function openSession()
        {
            try
            {
                let r = await post("/api/openSession", { });

                session_id = r.sessionId;

                alert("Session opened - " + session_id);
            }
            catch (err)
            {
                alert(err.message);
            }
        }

        async function closeSession()
        {
            try
            {
                let r = await post("/api/closeSession", { });
                session_id = null;
                alert("Session closed");
            }
            catch (err)
            {
                alert(err.message);
            }
        }

        async function testSession()
        {
            try
            {
                let r = await get("/api/folders");

                alert(JSON.stringify(r));;
            }
            catch (err)
            {
                alert(err.message);
            }
        }

        openSession();

    </script>
</head>
<body>
    
<button onclick="login()">Login</button>
<button onclick="openSession()">Open Session</button>
<button onclick="closeSession()">Close Session</button>
<button onclick="logout()">Logout</button>

<button onclick="testSession()">Test Session</button>
<button onclick="showToken()">Show Token</button>
</body>
</html>